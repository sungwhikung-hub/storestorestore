<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D ìŠ¤í† ì–´ (V26: ìƒí’ˆ ê´€ë¦¬ ì—ë””ì…˜)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .hidden { display: none !important; }
        .tab-active { color: #22c55e; border-bottom: 3px solid #22c55e; }
        .chat-bubble-me { background-color: #22c55e; color: white; border-radius: 18px 18px 4px 18px; align-self: flex-end; }
        .chat-bubble-other { background-color: #f1f5f9; color: #1e293b; border-radius: 18px 18px 18px 4px; align-self: flex-start; }
        @keyframes scroll { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .animate-scroll { animation: scroll 25s linear infinite; }
    </style>
</head>
<body class="min-h-screen pb-20">

    <div class="bg-slate-900 text-white py-2 overflow-hidden sticky top-0 z-[60]">
        <div class="animate-scroll whitespace-nowrap text-[10px] font-bold">
            ğŸ“¢ [V26] ê´€ë¦¬ì ì „ìš© ìƒí’ˆ ì¶”ê°€/ì‚­ì œ ê¸°ëŠ¥ ì—…ë°ì´íŠ¸! ì´ì œ ì‹¤ì‹œê°„ìœ¼ë¡œ ìƒì ì˜ ë©”ë‰´ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. / 1:1 ë©”ì‹œì§€ë¡œ ë¬¸ì˜ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”.
        </div>
    </div>

    <div id="auth-section" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md p-10 rounded-[3rem] shadow-2xl text-center border">
            <div id="login-form">
                <div class="text-6xl font-black text-green-500 mb-2">D</div>
                <h2 class="text-xl font-bold mb-8 italic text-slate-400 uppercase tracking-widest">D ìŠ¤í† ì–´ V26</h2>
                <div class="space-y-4">
                    <input type="text" id="login-id" placeholder="ì•„ì´ë””" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none focus:border-green-500">
                    <input type="password" id="login-pw" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none focus:border-green-500">
                    <button onclick="handleLogin()" class="w-full bg-green-500 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-green-600">ë¡œê·¸ì¸</button>
                </div>
                <button onclick="toggleAuth('signup')" class="mt-8 text-sm text-slate-400 font-bold underline">íšŒì›ê°€ì… í•˜ê¸°</button>
            </div>
            <div id="signup-form" class="hidden">
                <h2 class="text-2xl font-black mb-6">íšŒì›ê°€ì…</h2>
                <input type="text" id="signup-id" placeholder="í¬ë§ ì•„ì´ë”” (ë‹‰ë„¤ì„)" class="w-full p-4 bg-slate-50 rounded-2xl border mb-3 outline-none">
                <input type="password" id="signup-pw" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full p-4 bg-slate-50 rounded-2xl border mb-6 outline-none">
                <button onclick="handleSignup()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold">ê°€ì…í•˜ê¸°</button>
                <button onclick="toggleAuth('login')" class="mt-6 text-sm text-slate-400 block w-full text-center">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <div id="main-section" class="hidden">
        <header class="bg-white/80 backdrop-blur-md border-b sticky top-[34px] z-50">
            <div class="max-w-7xl mx-auto px-6 h-20 flex justify-between items-center">
                <div class="flex items-center gap-8">
                    <span class="text-3xl font-black text-green-500 cursor-pointer" onclick="switchView('shop')">D</span>
                    <nav class="flex gap-6 font-bold text-sm text-slate-400">
                        <button id="nav-shop" onclick="switchView('shop')" class="tab-active py-2">ìŠ¤í† ì–´</button>
                        <button id="nav-mypage" onclick="switchView('mypage')" class="py-2">ë§ˆì´í˜ì´ì§€</button>
                        <button id="nav-chat" onclick="switchView('chat')" class="py-2">ë©”ì‹œì§€</button>
                    </nav>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-3 bg-slate-100 pl-4 pr-2 py-2 rounded-2xl border border-slate-200">
                        <span id="user-info" class="text-[11px] font-bold text-slate-600"></span>
                        <div class="bg-white px-3 py-1.5 rounded-xl border border-slate-200"><span id="user-balance" class="font-black text-green-600 text-[11px]">0ì›</span></div>
                        <button onclick="openChargeModal()" class="bg-green-500 text-white text-[10px] px-3 py-1.5 rounded-lg font-bold">ì¶©ì „</button>
                    </div>
                    <button onclick="handleLogout()" class="text-xs font-bold text-slate-300 hover:text-red-500">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
        </header>

        <main id="view-shop" class="max-w-7xl mx-auto p-6 md:p-10">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-10">
                <div class="lg:col-span-3">
                    <div class="flex justify-between items-center mb-10">
                        <h2 class="text-3xl font-black text-slate-800">ì¶”ì²œ ìƒí’ˆ</h2>
                        <button id="admin-btn" onclick="toggleAdminModal()" class="hidden bg-slate-900 text-white text-[11px] px-6 py-3 rounded-2xl font-bold shadow-lg">ê´€ë¦¬ì ì„¼í„°</button>
                    </div>
                    <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-8"></div>
                </div>
                <aside>
                    <div class="bg-white p-8 rounded-[3rem] shadow-xl border border-slate-100 sticky top-32">
                        <h3 class="font-black text-xl mb-6">ì¥ë°”êµ¬ë‹ˆ <span id="cart-count" class="text-xs bg-green-50 text-green-600 px-2 py-1 rounded-lg">0</span></h3>
                        <div id="cart-items" class="space-y-4 mb-8 max-h-48 overflow-y-auto text-xs font-bold text-slate-500"></div>
                        
                        <div class="mb-6 p-5 bg-slate-50 rounded-[2rem] border border-slate-200 text-xs font-bold">
                            <p class="text-[10px] text-slate-400 mb-4 uppercase">ìˆ˜ë ¹ ë°©ì‹</p>
                            <div class="flex gap-4 mb-4">
                                <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="delivery-type" value="ì§ê±°ë˜" checked onclick="toggleAddressField(false)"> ì§ê±°ë˜</label>
                                <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="delivery-type" value="ë°°ë‹¬" onclick="toggleAddressField(true)"> ë°°ë‹¬</label>
                            </div>
                            <div id="address-container" class="hidden mt-2">
                                <input type="text" id="order-address" placeholder="ë°°ë‹¬ ìƒì„¸ ì£¼ì†Œ" class="w-full p-4 rounded-2xl bg-white border border-slate-200 outline-none focus:ring-1 ring-green-500">
                            </div>
                        </div>

                        <div class="flex justify-between text-2xl font-black mb-8 border-t pt-6"><span>í•©ê³„</span><span id="final-price" class="text-green-600">0ì›</span></div>
                        <button onclick="checkout()" class="w-full bg-slate-900 text-white py-5 rounded-[2rem] font-black shadow-lg">ê²°ì œí•˜ê¸°</button>
                    </div>
                </aside>
            </div>
        </main>

        <main id="view-mypage" class="max-w-3xl mx-auto p-6 md:p-10 hidden"><h2 class="text-3xl font-black mb-10">ë‚´ ì£¼ë¬¸ ë‚´ì—­</h2><div id="mypage-order-list" class="space-y-4"></div></main>
        <main id="view-chat" class="max-w-2xl mx-auto p-6 md:p-10 hidden">
            <h2 class="text-3xl font-black mb-10">ê´€ë¦¬ì ë¬¸ì˜</h2>
            <div class="bg-white rounded-[2.5rem] shadow-xl border overflow-hidden flex flex-col h-[500px]">
                <div id="chat-window" class="flex-1 p-6 overflow-y-auto flex flex-col gap-3 bg-slate-50"></div>
                <div class="p-4 bg-white border-t flex gap-2"><input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." class="flex-1 p-4 rounded-2xl bg-slate-100 outline-none text-sm font-bold"><button onclick="sendMessage('USER')" class="bg-green-500 text-white px-6 rounded-2xl font-bold">ì „ì†¡</button></div>
            </div>
        </main>
    </div>

    <div id="admin-modal" class="fixed inset-0 bg-black/70 backdrop-blur-md z-[100] flex items-center justify-center p-4 hidden">
        <div class="bg-white w-full max-w-6xl rounded-[3rem] p-10 shadow-2xl flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-8 border-b pb-6">
                <div class="flex items-center gap-4">
                    <h2 class="text-2xl font-black">ê´€ë¦¬ì ì„¼í„°</h2>
                    <nav class="flex bg-slate-100 p-1 rounded-2xl gap-1 ml-4 text-[11px] font-bold">
                        <button onclick="switchAdminTab('products')" id="btn-tab-products" class="px-4 py-2 rounded-xl">ìƒí’ˆ ê´€ë¦¬</button>
                        <button onclick="switchAdminTab('orders')" id="btn-tab-orders" class="px-4 py-2 rounded-xl">ì£¼ë¬¸ ë‚´ì—­</button>
                        <button onclick="switchAdminTab('charge')" id="btn-tab-charge" class="px-4 py-2 rounded-xl">ì¶©ì „ ê´€ë¦¬</button>
                        <button onclick="switchAdminTab('messages')" id="btn-tab-messages" class="px-4 py-2 rounded-xl">ë©”ì‹œì§€í•¨</button>
                        <button onclick="switchAdminTab('settings')" id="btn-tab-settings" class="px-4 py-2 rounded-xl">ê³„ì¢Œ ì„¤ì •</button>
                    </nav>
                </div>
                <button onclick="toggleAdminModal()" class="text-3xl">&times;</button>
            </div>

            <div id="admin-tab-products" class="hidden overflow-y-auto">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="bg-slate-50 p-6 rounded-[2rem] border h-fit">
                        <h4 class="text-xs font-black mb-4 text-slate-400 uppercase">ì‹ ê·œ ìƒí’ˆ ë“±ë¡</h4>
                        <div class="space-y-3">
                            <input type="text" id="new-p-name" placeholder="ìƒí’ˆëª…" class="w-full p-3 rounded-xl border text-xs outline-none">
                            <input type="number" id="new-p-price" placeholder="ê°€ê²©(ì›)" class="w-full p-3 rounded-xl border text-xs outline-none">
                            <input type="text" id="new-p-image" placeholder="ì´ë¯¸ì§€ URL (ì„ íƒì‚¬í•­)" class="w-full p-3 rounded-xl border text-xs outline-none">
                            <button onclick="addNewProduct()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold text-xs shadow-lg">ìƒì  ì§„ì—´í•˜ê¸°</button>
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <table class="w-full text-xs text-left">
                            <thead class="text-slate-400 border-b"><tr class="font-bold"><th class="pb-3">ìƒí’ˆëª…</th><th class="pb-3">ê°€ê²©</th><th class="pb-3 text-right">ê´€ë¦¬</th></tr></thead>
                            <tbody id="admin-product-list-body" class="divide-y"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="admin-tab-orders" class="hidden overflow-y-auto h-[50vh]"><table class="w-full text-[10px] text-left"><tbody id="admin-order-list" class="divide-y"></tbody></table></div>
            
            <div id="admin-tab-charge" class="hidden overflow-y-auto h-[50vh]"><table class="w-full text-xs text-left"><tbody id="admin-charge-list" class="divide-y"></tbody></table></div>
            
            <div id="admin-tab-messages" class="hidden grid grid-cols-1 md:grid-cols-3 gap-6 h-[50vh]">
                <div class="bg-slate-50 rounded-3xl p-4 overflow-y-auto border"><div id="admin-chat-user-list" class="space-y-2"></div></div>
                <div class="md:col-span-2 bg-white rounded-3xl border flex flex-col overflow-hidden">
                    <div id="admin-chat-window" class="flex-1 p-6 overflow-y-auto flex flex-col gap-2 bg-slate-50 text-xs font-bold"></div>
                    <div id="admin-chat-controls" class="p-4 bg-white border-t flex gap-2 hidden">
                        <input type="text" id="admin-chat-input" placeholder="ë‹µì¥ ì…ë ¥..." class="flex-1 p-3 rounded-xl bg-slate-100 outline-none text-xs font-bold">
                        <button onclick="sendMessage('ADMIN')" class="bg-slate-900 text-white px-5 rounded-xl font-bold">ì „ì†¡</button>
                    </div>
                </div>
            </div>

            <div id="admin-tab-settings" class="hidden max-w-md mx-auto w-full"><textarea id="admin-account-input" class="w-full h-32 p-4 rounded-2xl border text-sm mb-4 outline-none"></textarea><button onclick="saveStoreSettings()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold">ê³„ì¢Œì •ë³´ ì—…ë°ì´íŠ¸</button></div>
        </div>
    </div>

    <div id="charge-modal" class="fixed inset-0 bg-black/60 z-[110] flex items-center justify-center p-4 hidden">
        <div class="bg-white w-full max-w-sm rounded-[3.5rem] p-10 shadow-2xl text-center border">
            <h2 class="text-2xl font-black mb-2">ì”ì•¡ ì¶©ì „</h2>
            <div id="charge-account-display" class="bg-slate-50 p-4 rounded-2xl mb-6 text-[10px] font-bold border border-dashed text-slate-500"></div>
            <input type="text" id="charge-name" placeholder="ì…ê¸ˆì ì„±í•¨" class="w-full p-4 bg-slate-50 rounded-2xl mb-3 border text-center font-bold outline-none">
            <input type="number" id="charge-amount" placeholder="ì¶©ì „í•  ê¸ˆì•¡" class="w-full p-4 bg-slate-50 rounded-2xl mb-8 border text-center font-black text-2xl outline-none">
            <div class="flex gap-3">
                <button onclick="requestCharge()" class="flex-1 bg-green-500 text-white py-4 rounded-2xl font-bold">ì‹ ì²­</button>
                <button onclick="closeChargeModal()" class="flex-1 bg-slate-100 py-4 rounded-2xl font-bold">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <script>
        const DB_KEY = "D_STORE_V26";
        let users = JSON.parse(localStorage.getItem(DB_KEY + '_users')) || [];
        let currentUser = JSON.parse(localStorage.getItem(DB_KEY + '_session')) || null;
        let products = JSON.parse(localStorage.getItem(DB_KEY + '_products')) || [
            { id: 1, name: 'ì—í‹°ì˜¤í”¼ì•„ ì˜ˆê°€ì²´í”„ G1 200g', price: 18000, image: 'https://images.unsplash.com/photo-1559056199-641a0ac8b55e?w=400' },
            { id: 2, name: 'ì½œë“œë¸Œë£¨ ì›ì•¡ 500ml', price: 15000, image: 'https://images.unsplash.com/photo-1544190807-c7379538cbb4?w=400' }
        ];
        let orders = JSON.parse(localStorage.getItem(DB_KEY + '_orders')) || [];
        let chargeRequests = JSON.parse(localStorage.getItem(DB_KEY + '_charge_req')) || [];
        let messages = JSON.parse(localStorage.getItem(DB_KEY + '_messages')) || [];
        let storeSettings = JSON.parse(localStorage.getItem(DB_KEY + '_settings')) || { account: "ì‹ í•œì€í–‰ 110-123-456789 (DìŠ¤í† ì–´)" };

        let cart = [];
        let selectedUserForChat = null;

        // --- ì¸ì¦ ë¡œì§ ---
        function toggleAuth(type) { document.getElementById('login-form').classList.toggle('hidden', type === 'signup'); document.getElementById('signup-form').classList.toggle('hidden', type === 'login'); }
        function handleSignup() {
            const id = document.getElementById('signup-id').value.trim();
            const pw = document.getElementById('signup-pw').value.trim();
            if(!id || !pw) return alert("ì…ë ¥ ì •ë³´ ë¶€ì¡±");
            if(users.some(u => u.id === id)) return alert("ì¤‘ë³µëœ ì•„ì´ë””ì…ë‹ˆë‹¤.");
            users.push({ id, pw, balance: 0, role: id.toLowerCase() === 'admin' ? 'ADMIN' : 'USER' });
            localStorage.setItem(DB_KEY + '_users', JSON.stringify(users));
            alert("íšŒì›ê°€ì… ì™„ë£Œ!"); toggleAuth('login');
        }
        function handleLogin() {
            const id = document.getElementById('login-id').value;
            const pw = document.getElementById('login-pw').value;
            const user = users.find(u => u.id === id && u.pw === pw);
            if(user) { currentUser = user; localStorage.setItem(DB_KEY + '_session', JSON.stringify(currentUser)); showMain(); }
            else alert("ë¡œê·¸ì¸ ì •ë³´ ë¶ˆì¼ì¹˜");
        }
        function handleLogout() { localStorage.removeItem(DB_KEY + '_session'); location.reload(); }
        function showMain() {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('main-section').classList.remove('hidden');
            document.getElementById('user-info').innerText = currentUser.id + "ë‹˜";
            if(currentUser.role === 'ADMIN') document.getElementById('admin-btn').classList.remove('hidden');
            updateUI();
        }

        // --- UI ì—…ë°ì´íŠ¸ ---
        function updateUI() {
            const freshUser = users.find(u => u.id === currentUser.id);
            document.getElementById('user-balance').innerText = freshUser.balance.toLocaleString() + 'ì›';
            renderShop(); renderAdminProducts(); renderAdminOrders(); renderAdminChargeList(); renderAdminChatUserList();
            if(document.getElementById('view-chat').offsetParent) renderUserChat();
        }

        // --- ìƒí’ˆ ê´€ë¦¬ (V26: ì¶”ê°€ ë° ì‚­ì œ) ---
        function addNewProduct() {
            const name = document.getElementById('new-p-name').value.trim();
            const price = parseInt(document.getElementById('new-p-price').value);
            const img = document.getElementById('new-p-image').value.trim() || 'https://via.placeholder.com/400x300?text=Product';

            if(!name || isNaN(price)) return alert("ìƒí’ˆëª…ê³¼ ê°€ê²©ì„ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”.");

            const newProduct = { id: Date.now(), name, price, image: img };
            products.unshift(newProduct);
            localStorage.setItem(DB_KEY + '_products', JSON.stringify(products));
            
            // ì…ë ¥ì°½ ì´ˆê¸°í™”
            document.getElementById('new-p-name').value = '';
            document.getElementById('new-p-price').value = '';
            document.getElementById('new-p-image').value = '';

            alert("ìƒí’ˆì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
            updateUI();
        }

        function deleteProduct(id) {
            if(!confirm("ì´ ìƒí’ˆì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            products = products.filter(p => p.id !== id);
            localStorage.setItem(DB_KEY + '_products', JSON.stringify(products));
            updateUI();
        }

        function renderAdminProducts() {
            const listBody = document.getElementById('admin-product-list-body');
            listBody.innerHTML = products.map(p => `
                <tr class="hover:bg-slate-50">
                    <td class="py-4 font-bold text-slate-700">${p.name}</td>
                    <td class="font-black text-slate-500">${p.price.toLocaleString()}ì›</td>
                    <td class="text-right py-4">
                        <button onclick="deleteProduct(${p.id})" class="bg-red-50 text-red-500 px-3 py-1 rounded-lg font-bold hover:bg-red-500 hover:text-white transition">ì‚­ì œ</button>
                    </td>
                </tr>`).join('') || '<tr><td colspan="3" class="text-center py-10 text-slate-400">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        }

        // --- ìŠ¤í† ì–´ & ì£¼ë¬¸ ---
        function renderShop() {
            document.getElementById('product-list').innerHTML = products.map(p => `
                <div class="bg-white p-6 rounded-[2.5rem] border hover:shadow-lg transition">
                    <img src="${p.image}" class="w-full h-40 object-cover rounded-[2rem] mb-4 shadow-sm">
                    <h3 class="font-bold text-xs mb-1 text-slate-800">${p.name}</h3>
                    <div class="flex justify-between items-center"><span class="font-black text-sm">${p.price.toLocaleString()}ì›</span>
                    <button onclick="addToCart(${p.id})" class="bg-green-500 text-white px-4 py-2 rounded-xl text-[10px] font-bold">ë‹´ê¸°</button></div>
                </div>`).join('') || '<p class="col-span-full text-center py-20 text-slate-400 font-bold">í˜„ì¬ ìƒì ì— ì§„ì—´ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        }

        function addToCart(id) { cart.push(products.find(p => p.id === id)); updateCart(); }
        function updateCart() {
            const total = cart.reduce((s, i) => s + i.price, 0);
            document.getElementById('cart-items').innerHTML = cart.map((i, idx) => `<div class="flex justify-between items-center bg-slate-50 p-3 rounded-xl"><span>${i.name}</span><button onclick="removeFromCart(${idx})" class="text-red-400">X</button></div>`).join('');
            document.getElementById('cart-count').innerText = cart.length;
            document.getElementById('final-price').innerText = total.toLocaleString() + 'ì›';
        }
        function removeFromCart(idx) { cart.splice(idx, 1); updateCart(); }
        function toggleAddressField(show) { document.getElementById('address-container').classList.toggle('hidden', !show); }
        function checkout() {
            const total = cart.reduce((s, i) => s + i.price, 0);
            const freshUser = users.find(u => u.id === currentUser.id);
            if(!cart.length || freshUser.balance < total) return alert("ì¥ë°”êµ¬ë‹ˆ í™•ì¸ í˜¹ì€ ì”ì•¡ ë¶€ì¡±");
            const type = document.querySelector('input[name="delivery-type"]:checked').value;
            const addr = document.getElementById('order-address').value.trim();
            if(type === 'ë°°ë‹¬' && !addr) return alert("ìƒì„¸ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            freshUser.balance -= total;
            orders.unshift({ id: Date.now(), user: currentUser.id, items: cart.map(i => i.name).join(', '), total, type, address: type === 'ë°°ë‹¬' ? addr : 'ì§ê±°ë˜', date: new Date().toLocaleString() });
            cart = []; updateCart(); localStorage.setItem(DB_KEY + '_users', JSON.stringify(users)); localStorage.setItem(DB_KEY + '_orders', JSON.stringify(orders));
            alert("ê²°ì œ ë° ì£¼ë¬¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"); updateUI();
        }

        // --- ì¶©ì „ & ë©”ì‹œì§€ & ìœ í‹¸ë¦¬í‹° (ê¸°ì¡´ ë¡œì§ ìœ ì§€) ---
        function approveCharge(id) {
            const r = chargeRequests.find(req => req.id === id);
            users.find(u => u.id === r.userId).balance += r.amount;
            r.status = 'ìŠ¹ì¸ë¨'; saveChargeData(); alert("ìŠ¹ì¸ ì™„ë£Œ");
        }
        function rejectCharge(id) { if(confirm("ì‹ ì²­ì„ ê±°ë¶€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { chargeRequests.find(r => r.id === id).status = 'ê±°ë¶€ë¨'; saveChargeData(); alert("ê±°ë¶€ ì²˜ë¦¬ë¨"); } }
        function saveChargeData() { localStorage.setItem(DB_KEY + '_users', JSON.stringify(users)); localStorage.setItem(DB_KEY + '_charge_req', JSON.stringify(chargeRequests)); updateUI(); }
        
        function sendMessage(role) {
            const inputId = role === 'ADMIN' ? 'admin-chat-input' : 'chat-input';
            const text = document.getElementById(inputId).value.trim();
            if(!text) return;
            messages.push({ id: Date.now(), sender: currentUser.id, receiver: role === 'ADMIN' ? selectedUserForChat : 'admin', text, time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) });
            localStorage.setItem(DB_KEY + '_messages', JSON.stringify(messages));
            document.getElementById(inputId).value = '';
            role === 'ADMIN' ? renderAdminChat(selectedUserForChat) : renderUserChat();
            renderAdminChatUserList();
        }
        function renderUserChat() {
            const win = document.getElementById('chat-window');
            win.innerHTML = messages.filter(m => m.sender === currentUser.id || m.receiver === currentUser.id).map(m => `<div class="${m.sender === currentUser.id ? 'chat-bubble-me' : 'chat-bubble-other'} p-3 max-w-[80%] font-bold text-xs mb-1 shadow-sm">${m.text}</div>`).join('');
            win.scrollTop = win.scrollHeight;
        }
        function renderAdminChatUserList() {
            const uList = [...new Set(messages.map(m => m.sender === 'admin' ? m.receiver : m.sender))];
            document.getElementById('admin-chat-user-list').innerHTML = uList.map(uId => `<div onclick="selectChatUser('${uId}')" class="p-3 rounded-xl cursor-pointer font-bold text-xs mb-1 ${selectedUserForChat === uId ? 'bg-green-500 text-white shadow-md' : 'bg-white border'}">${uId}</div>`).join('');
        }
        function selectChatUser(uId) { selectedUserForChat = uId; document.getElementById('admin-chat-controls').classList.remove('hidden'); renderAdminChat(uId); renderAdminChatUserList(); }
        function renderAdminChat(uId) {
            const win = document.getElementById('admin-chat-window');
            win.innerHTML = messages.filter(m => (m.sender === uId && m.receiver === 'admin') || (m.sender === 'admin' && m.receiver === uId)).map(m => `<div class="${m.sender === 'admin' ? 'chat-bubble-me' : 'chat-bubble-other'} p-2 max-w-[90%] text-[10px] font-bold mb-1 shadow-sm">${m.text}</div>`).join('');
            win.scrollTop = win.scrollHeight;
        }

        function switchAdminTab(t) { ['products', 'orders', 'charge', 'messages', 'settings'].forEach(tab => { document.getElementById('admin-tab-' + tab).classList.toggle('hidden', t !== tab); const b = document.getElementById('btn-tab-' + tab); if(b) b.className = t === tab ? "px-4 py-2 rounded-xl bg-slate-900 text-white" : "px-4 py-2 rounded-xl bg-white border text-slate-400"; }); }
        function switchView(v) { ['shop', 'mypage', 'chat'].forEach(view => { document.getElementById('view-' + view).classList.toggle('hidden', v !== view); document.getElementById('nav-' + view).className = v === view ? 'tab-active py-2' : 'py-2'; }); if(v === 'chat') renderUserChat(); if(v === 'mypage') renderMyOrders(); }
        function renderMyOrders() { const my = orders.filter(o => o.user === currentUser.id); document.getElementById('mypage-order-list').innerHTML = my.map(o => `<div class="bg-white p-6 rounded-3xl border flex justify-between items-center shadow-sm"><div><p class="text-[10px] font-bold text-slate-400">${o.date} [${o.type}]</p><h4 class="font-bold text-sm text-slate-700">${o.items}</h4><p class="text-[9px] text-slate-400">${o.address}</p></div><span class="font-black text-green-600">${o.total.toLocaleString()}ì›</span></div>`).join('') || '<p class="text-center py-20 text-slate-300 font-bold">ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; }
        function renderAdminOrders() { document.getElementById('admin-order-list').innerHTML = orders.map(o => `<tr class="border-b"><td class="py-2 px-2 font-bold">${o.user}</td><td>${o.items}</td><td>${o.total.toLocaleString()}ì›</td><td>${o.type}</td><td>${o.address}</td></tr>`).join('') || '<tr><td colspan="5" class="text-center py-10">ë‚´ì—­ ì—†ìŒ</td></tr>'; }
        function renderAdminChargeList() { document.getElementById('admin-charge-list').innerHTML = chargeRequests.filter(r => r.status === 'ëŒ€ê¸°').map(r => `<tr><td class="py-4 font-bold text-slate-700">${r.userId}</td><td>${r.name}</td><td class="font-black text-green-600">${r.amount.toLocaleString()}ì›</td><td class="text-right py-4 flex justify-end gap-2"><button onclick="approveCharge(${r.id})" class="bg-black text-white px-3 py-1.5 rounded-lg font-bold">ìŠ¹ì¸</button><button onclick="rejectCharge(${r.id})" class="bg-red-500 text-white px-3 py-1.5 rounded-lg font-bold">ê±°ë¶€</button></td></tr>`).join('') || '<tr><td colspan="4" class="text-center py-10 text-slate-400 font-bold">ì‹ ì²­ ë‚´ì—­ ì—†ìŒ</td></tr>'; }
        function saveStoreSettings() { storeSettings.account = document.getElementById('admin-account-input').value; localStorage.setItem(DB_KEY + '_settings', JSON.stringify(storeSettings)); alert("ê³„ì¢Œ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); }
        function openChargeModal() { document.getElementById('charge-account-display').innerText = storeSettings.account; document.getElementById('charge-modal').classList.remove('hidden'); }
        function closeChargeModal() { document.getElementById('charge-modal').classList.add('hidden'); }
        function requestCharge() {
            const n = document.getElementById('charge-name').value;
            const a = parseInt(document.getElementById('charge-amount').value);
            if(n && a) { chargeRequests.push({ id: Date.now(), userId: currentUser.id, name: n, amount: a, status: 'ëŒ€ê¸°' }); localStorage.setItem(DB_KEY + '_charge_req', JSON.stringify(chargeRequests)); alert("ì¶©ì „ ì‹ ì²­ ì™„ë£Œ!"); closeChargeModal(); updateUI(); }
        }
        function toggleAdminModal() { document.getElementById('admin-modal').classList.toggle('hidden'); switchAdminTab('products'); }
        if(currentUser) showMain();
    </script>
</body>
</html>