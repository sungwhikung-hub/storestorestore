<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D 스토어 - 클라우드 통합 버전</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; }
        .hidden { display: none !important; }
        .tab-active { color: #22c55e; border-bottom: 3px solid #22c55e; }
        .chat-bubble-me { background-color: #22c55e; color: white; border-radius: 18px 18px 4px 18px; align-self: flex-end; }
        .chat-bubble-other { background-color: #f1f5f9; color: #1e293b; border-radius: 18px 18px 18px 4px; align-self: flex-start; }
    </style>
</head>
<body>

    <div id="auth-section" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md p-10 rounded-[3rem] shadow-2xl border text-center">
            <div id="login-form">
                <div class="text-6xl font-black text-green-500 mb-2">D</div>
                <h2 class="text-xl font-bold mb-8 italic text-slate-400 uppercase tracking-widest">D STORE CLOUD</h2>
                <div class="space-y-4">
                    <input type="text" id="login-id" placeholder="아이디" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none focus:border-green-500">
                    <input type="password" id="login-pw" placeholder="비밀번호" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none focus:border-green-500">
                    <button onclick="handleLogin()" class="w-full bg-green-500 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-green-600">로그인</button>
                </div>
                <button onclick="toggleAuth('signup')" class="mt-8 text-sm text-slate-400 font-bold underline">회원가입 하기</button>
            </div>
            
            <div id="signup-form" class="hidden">
                <h2 class="text-2xl font-black mb-6">회원가입</h2>
                <div class="space-y-4">
                    <input type="text" id="signup-id" placeholder="희망 아이디" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none focus:border-green-500">
                    <input type="password" id="signup-pw" placeholder="비밀번호" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none focus:border-green-500">
                    <button onclick="handleSignup()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold">가입하기</button>
                    <button onclick="toggleAuth('login')" class="mt-4 text-sm text-slate-400 block w-full text-center">취소</button>
                </div>
            </div>
        </div>
    </div>

    <div id="main-section" class="hidden">
        <header class="bg-white border-b sticky top-0 z-50 px-6 h-20 flex justify-between items-center shadow-sm">
            <div class="flex items-center gap-8">
                <span class="text-3xl font-black text-green-500 cursor-pointer" onclick="switchView('shop')">D</span>
                <nav class="flex gap-6 font-bold text-sm text-slate-400">
                    <button id="nav-shop" onclick="switchView('shop')" class="tab-active py-2">스토어</button>
                    <button id="nav-chat" onclick="switchView('chat')" class="py-2">메시지</button>
                </nav>
            </div>
            <div class="flex items-center gap-4">
                <div class="bg-slate-100 px-4 py-2 rounded-xl text-xs font-bold">
                    <span id="display-id"></span> | <span id="display-balance" class="text-green-600">0원</span>
                </div>
                <button id="admin-btn" onclick="toggleAdminModal()" class="hidden bg-slate-900 text-white text-[10px] px-3 py-2 rounded-lg font-bold">관리자</button>
                <button onclick="handleLogout()" class="text-xs text-slate-400 font-bold">로그아웃</button>
            </div>
        </header>

        <main id="view-shop" class="max-w-7xl mx-auto p-10">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-10">
                <div class="md:col-span-3">
                    <h2 class="text-3xl font-black mb-10 text-slate-800">추천 상품</h2>
                    <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8"></div>
                </div>
                <aside>
                    <div class="bg-white p-6 rounded-[2rem] shadow-xl border sticky top-24">
                        <h3 class="font-black mb-4">장바구니</h3>
                        <div id="cart-list" class="space-y-2 mb-6 text-sm"></div>
                        <div class="flex justify-between font-black text-xl mb-6"><span>합계</span><span id="cart-total">0원</span></div>
                        <button onclick="checkout()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold">결제하기</button>
                    </div>
                </aside>
            </div>
        </main>

        <main id="view-chat" class="max-w-2xl mx-auto p-10 hidden">
            <h2 class="text-2xl font-black mb-6">관리자 문의</h2>
            <div class="bg-white rounded-[2rem] shadow-xl border h-[500px] flex flex-col overflow-hidden">
                <div id="chat-window" class="flex-1 p-6 overflow-y-auto flex flex-col gap-2 bg-slate-50"></div>
                <div class="p-4 flex gap-2 border-t bg-white">
                    <input type="text" id="chat-input" class="flex-1 p-3 bg-slate-100 rounded-xl outline-none" placeholder="메시지를 입력하세요...">
                    <button onclick="sendChatMessage()" class="bg-green-500 text-white px-6 rounded-xl font-bold">전송</button>
                </div>
            </div>
        </main>
    </div>

    <div id="admin-modal" class="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-6 hidden">
        <div class="bg-white w-full max-w-4xl rounded-[2rem] p-10 max-h-[90vh] overflow-y-auto shadow-2xl">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-black">관리자 센터</h2>
                <button onclick="toggleAdminModal()" class="text-3xl">&times;</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-slate-50 p-6 rounded-2xl border">
                    <h3 class="font-bold mb-4 italic">신규 상품 등록</h3>
                    <div class="space-y-3">
                        <input type="text" id="new-p-name" placeholder="상품명" class="w-full p-3 border rounded-xl outline-none">
                        <input type="number" id="new-p-price" placeholder="가격" class="w-full p-3 border rounded-xl outline-none">
                        <input type="text" id="new-p-img" placeholder="이미지 주소" class="w-full p-3 border rounded-xl outline-none">
                        <button onclick="addNewProduct()" class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold">등록하기</button>
                    </div>
                </div>
                <div>
                    <h3 class="font-bold mb-4">상품 관리</h3>
                    <div id="admin-p-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 1. Firebase 설정 (제공해주신 설정 그대로 유지)
        const firebaseConfig = {
            apiKey: "AIzaSyDqD4T5zKE0f364i3kuV_Kkg-nFQA-oB_M",
            authDomain: "hyogi090909-aa01a.firebaseapp.com",
            projectId: "hyogi090909-aa01a",
            storageBucket: "hyogi090909-aa01a.firebasestorage.app",
            messagingSenderId: "1085220308476",
            appId: "1:1085220308476:web:b698d077349f7c1df89e79",
            measurementId: "G-YM55N961MZ"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentUser = null;
        let cart = [];

        // 2. 인증 함수 (doc.exists() -> doc.exists로 모두 수정완료)
        function toggleAuth(type) {
            document.getElementById('login-form').classList.toggle('hidden', type === 'signup');
            document.getElementById('signup-form').classList.toggle('hidden', type === 'login');
        }

        async function handleSignup() {
            const id = document.getElementById('signup-id').value.trim();
            const pw = document.getElementById('signup-pw').value.trim();
            if(!id || !pw) return alert("내용을 입력해주세요.");
            
            try {
                const userRef = db.collection("users").doc(id);
                const doc = await userRef.get();
                
                // [수정 포인트] doc.exists() 가 아니라 doc.exists 입니다.
                if(doc.exists) { 
                    alert("이미 존재하는 아이디입니다.");
                    return;
                }

                await userRef.set({
                    id, pw, balance: 100000, 
                    role: id.toLowerCase() === 'admin' ? 'ADMIN' : 'USER' 
                });
                alert("가입 성공! 로그인해 주세요.");
                toggleAuth('login');
            } catch(e) { alert("가입 실패: " + e.message); }
        }

        async function handleLogin() {
            const id = document.getElementById('login-id').value.trim();
            const pw = document.getElementById('login-pw').value.trim();
            
            try {
                const doc = await db.collection("users").doc(id).get();
                // [수정 포인트] doc.exists() 가 아니라 doc.exists 입니다.
                if(doc.exists && doc.data().pw === pw) {
                    currentUser = doc.data();
                    localStorage.setItem('D_SESSION', JSON.stringify(currentUser));
                    showMainStore();
                } else {
                    alert("아이디 또는 비밀번호가 틀립니다.");
                }
            } catch(e) { alert("로그인 실패: " + e.message); }
        }

        function handleLogout() { localStorage.removeItem('D_SESSION'); location.reload(); }

        // 3. 메인 기능
        function showMainStore() {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('main-section').classList.remove('hidden');
            document.getElementById('display-id').innerText = currentUser.id;
            
            if(currentUser.role === 'ADMIN') {
                document.getElementById('admin-btn').classList.remove('hidden');
            }
            
            // 실시간 리스너 작동
            loadDataRealtime();
        }

        function loadDataRealtime() {
            // 유저 정보(잔액) 실시간 업데이트
            db.collection("users").doc(currentUser.id).onSnapshot(doc => {
                if(doc.exists) {
                    currentUser = doc.data();
                    document.getElementById('display-balance').innerText = currentUser.balance.toLocaleString() + '원';
                }
            });

            // 상품 목록 실시간 업데이트
            db.collection("products").onSnapshot(snapshot => {
                const products = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                renderShop(products);
            });

            // 채팅 실시간 업데이트
            db.collection("messages").orderBy("time", "asc").onSnapshot(snapshot => {
                const msgs = snapshot.docs.map(doc => doc.data());
                renderChat(msgs);
            });
        }

        function renderShop(products) {
            const list = document.getElementById('product-list');
            list.innerHTML = products.map(p => `
                <div class="bg-white p-6 rounded-[2.5rem] border shadow-sm hover:shadow-md transition">
                    <img src="${p.img}" class="w-full h-40 object-cover rounded-2xl mb-4">
                    <h4 class="font-bold text-lg mb-1">${p.name}</h4>
                    <div class="flex justify-between items-center">
                        <span class="text-green-600 font-black">${Number(p.price).toLocaleString()}원</span>
                        <button onclick="addToCart('${p.id}', '${p.name}', ${p.price})" class="bg-slate-900 text-white px-4 py-2 rounded-xl text-xs font-bold">담기</button>
                    </div>
                </div>
            `).join('');

            const adminList = document.getElementById('admin-p-list');
            adminList.innerHTML = products.map(p => `
                <div class="flex justify-between items-center p-3 bg-slate-50 border rounded-xl">
                    <span class="text-sm font-bold">${p.name}</span>
                    <button onclick="deleteProduct('${p.id}')" class="text-red-500 text-xs font-bold">삭제</button>
                </div>
            `).join('');
        }

        // 4. 상품 및 장바구니 로직
        async function addNewProduct() {
            const name = document.getElementById('new-p-name').value;
            const price = document.getElementById('new-p-price').value;
            const img = document.getElementById('new-p-img').value || 'https://via.placeholder.com/150';
            if(!name || !price) return;
            await db.collection("products").add({ name, price, img, time: Date.now() });
            alert("상품 등록됨");
            document.getElementById('new-p-name').value = '';
            document.getElementById('new-p-price').value = '';
        }

        async function deleteProduct(id) {
            if(confirm("삭제할까요?")) await db.collection("products").doc(id).delete();
        }

        function addToCart(id, name, price) {
            cart.push({id, name, price});
            updateCartUI();
        }

        function updateCartUI() {
            const total = cart.reduce((sum, item) => sum + Number(item.price), 0);
            document.getElementById('cart-list').innerHTML = cart.map((item, idx) => `
                <div class="flex justify-between items-center p-2 bg-slate-50 rounded-lg">
                    <span>${item.name}</span>
                    <button onclick="cart.splice(${idx}, 1); updateCartUI();" class="text-red-400">×</button>
                </div>
            `).join('');
            document.getElementById('cart-total').innerText = total.toLocaleString() + '원';
        }

        async function checkout() {
            const total = cart.reduce((sum, item) => sum + Number(item.price), 0);
            if(cart.length === 0) return alert("장바구니가 비었습니다.");
            if(currentUser.balance < total) return alert("잔액이 부족합니다.");

            await db.collection("users").doc(currentUser.id).update({
                balance: currentUser.balance - total
            });
            alert("구매 성공!");
            cart = [];
            updateCartUI();
        }

        // 5. 채팅 로직
        async function sendChatMessage() {
            const text = document.getElementById('chat-input').value.trim();
            if(!text) return;
            await db.collection("messages").add({
                sender: currentUser.id,
                text: text,
                time: Date.now()
            });
            document.getElementById('chat-input').value = '';
        }

        function renderChat(msgs) {
            const win = document.getElementById('chat-window');
            win.innerHTML = msgs.map(m => `
                <div class="${m.sender === currentUser.id ? 'chat-bubble-me' : 'chat-bubble-other'} p-3 max-w-[80%] text-sm font-bold shadow-sm">
                    ${m.sender !== currentUser.id ? `<div class='text-[10px] opacity-50 mb-1'>${m.sender}</div>` : ''}
                    ${m.text}
                </div>
            `).join('');
            win.scrollTop = win.scrollHeight;
        }

        // 6. UI 제어
        function switchView(view) {
            document.getElementById('view-shop').classList.toggle('hidden', view !== 'shop');
            document.getElementById('view-chat').classList.toggle('hidden', view !== 'chat');
            document.getElementById('nav-shop').classList.toggle('tab-active', view === 'shop');
            document.getElementById('nav-chat').classList.toggle('tab-active', view === 'chat');
        }
        function toggleAdminModal() { document.getElementById('admin-modal').classList.toggle('hidden'); }

        // 자동 로그인 체크
        window.onload = () => {
            const saved = localStorage.getItem('D_SESSION');
            if(saved) {
                currentUser = JSON.parse(saved);
                showMainStore();
            }
        };
    </script>
</body>
</html>
