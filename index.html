<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D 스토어 클라우드</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>

    <script>
        // 1. Firebase 설정 (사용자님 정보 적용 완료)
        const firebaseConfig = {
            apiKey: "AIzaSyDqD4T5zKE0f364i3kuV_Kkg-nFQA-oB_M",
            authDomain: "hyogi090909-aa01a.firebaseapp.com",
            projectId: "hyogi090909-aa01a",
            storageBucket: "hyogi090909-aa01a.firebasestorage.app",
            messagingSenderId: "1085220308476",
            appId: "1:1085220308476:web:b698d077349f7c1df89e79",
            measurementId: "G-YM55N961MZ"
        };

        // 초기화
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // 회원가입 함수
        async function handleSignup() {
            const id = document.getElementById('signup-id').value.trim();
            const pw = document.getElementById('signup-pw').value.trim();
            
            if(!id || !pw) return alert("아이디와 비밀번호를 모두 입력하세요.");

            try {
                const userRef = db.collection("users").doc(id);
                const doc = await userRef.get();
                
                if(doc.exists) { // 괄호 삭제함 (수정완료)
                    alert("이미 존재하는 아이디입니다.");
                    return;
                }

                await userRef.set({
                    id: id,
                    pw: pw,
                    balance: 0,
                    role: id.toLowerCase() === 'admin' ? 'ADMIN' : 'USER',
                    createdAt: Date.now()
                });
                
                alert("가입 성공! 이제 로그인해주세요.");
                toggleAuth('login');
            } catch (error) {
                console.error("회원가입 에러:", error);
                alert("에러 발생: " + error.message);
            }
        }

        // 로그인 함수
        async function handleLogin() {
            const id = document.getElementById('login-id').value.trim();
            const pw = document.getElementById('login-pw').value.trim();

            if(!id || !pw) return alert("아이디와 비밀번호를 입력하세요.");

            try {
                const userRef = db.collection("users").doc(id);
                const doc = await userRef.get();

                // doc.exists (괄호 없음)로 수정
                if(doc.exists && doc.data().pw === pw) {
                    const userData = doc.data();
                    localStorage.setItem('D_STORE_SESSION', JSON.stringify(userData));
                    alert(id + "님 환영합니다!");
                    // 로그인 성공 시 메인 화면으로 이동하거나 페이지 갱신
                    location.reload(); 
                } else {
                    alert("아이디 또는 비밀번호가 틀립니다.");
                }
            } catch (error) {
                console.error("로그인 에러:", error);
                alert("로그인 실패: 데이터베이스 연결을 확인하세요.");
            }
        }

        function toggleAuth(type) {
            document.getElementById('login-form').classList.toggle('hidden', type === 'signup');
            document.getElementById('signup-form').classList.toggle('hidden', type === 'login');
        }

        // 초기 실행: 이미 로그인되어 있는지 확인
        window.onload = () => {
            const session = localStorage.getItem('D_STORE_SESSION');
            if (session) {
                const user = JSON.parse(session);
                document.body.innerHTML = `
                    <div class="flex flex-col items-center justify-center min-h-screen">
                        <h1 class="text-2xl font-bold mb-4">${user.id}님 로그인 상태입니다!</h1>
                        <p class="mb-4">이제 스토어 기능을 이용할 수 있습니다.</p>
                        <button onclick="localStorage.removeItem('D_STORE_SESSION'); location.reload();" class="bg-red-500 text-white px-4 py-2 rounded">로그아웃</button>
                    </div>
                `;
            }
        };
    </script>
    <style>.hidden { display: none; }</style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen font-sans">

    <div class="bg-white p-10 rounded-[2rem] shadow-2xl w-full max-w-md border">
        <div id="login-form">
            <h2 class="text-3xl font-black mb-8 text-center text-green-500">D STORE</h2>
            <div class="space-y-4">
                <input type="text" id="login-id" placeholder="아이디" class="w-full p-4 bg-slate-50 border rounded-2xl outline-none focus:border-green-500">
                <input type="password" id="login-pw" placeholder="비밀번호" class="w-full p-4 bg-slate-50 border rounded-2xl outline-none focus:border-green-500">
                <button onclick="handleLogin()" class="w-full bg-green-500 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-green-600 transition">로그인</button>
            </div>
            <button onclick="toggleAuth('signup')" class="w-full mt-6 text-sm text-slate-400 font-bold underline">계정이 없으신가요? 회원가입</button>
        </div>

        <div id="signup-form" class="hidden">
            <h2 class="text-2xl font-bold mb-8 text-center">신규 가입</h2>
            <div class="space-y-4">
                <input type="text" id="signup-id" placeholder="희망 아이디" class="w-full p-4 bg-slate-50 border rounded-2xl outline-none focus:border-blue-500">
                <input type="password" id="signup-pw" placeholder="비밀번호" class="w-full p-4 bg-slate-50 border rounded-2xl outline-none focus:border-blue-500">
                <button onclick="handleSignup()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold shadow-lg">가입 완료</button>
            </div>
            <button onclick="toggleAuth('login')" class="w-full mt-6 text-sm text-slate-400 font-bold">돌아가기</button>
        </div>
    </div>

</body>
</html>
