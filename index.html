<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D ìŠ¤í† ì–´ (ì‹¤ì‹œê°„ í´ë¼ìš°ë“œ ì—ë””ì…˜)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .hidden { display: none !important; }
        .tab-active { color: #22c55e; border-bottom: 3px solid #22c55e; }
        .chat-bubble-me { background-color: #22c55e; color: white; border-radius: 18px 18px 4px 18px; align-self: flex-end; }
        .chat-bubble-other { background-color: #f1f5f9; color: #1e293b; border-radius: 18px 18px 18px 4px; align-self: flex-start; }
        @keyframes scroll { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .animate-scroll { animation: scroll 25s linear infinite; }
    </style>
</head>
<body class="min-h-screen pb-20">

    <div class="bg-slate-900 text-white py-2 overflow-hidden sticky top-0 z-[60]">
        <div class="animate-scroll whitespace-nowrap text-[10px] font-bold">
            ğŸ“¢ [V26-Cloud] ì‹¤ì‹œê°„ ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™ ì™„ë£Œ! ëª¨ë“  ë°ì´í„°ëŠ” í´ë¼ìš°ë“œì— ì €ì¥ë©ë‹ˆë‹¤.
        </div>
    </div>

    <div id="auth-section" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md p-10 rounded-[3rem] shadow-2xl text-center border">
            <div id="login-form">
                <div class="text-6xl font-black text-green-500 mb-2">D</div>
                <h2 class="text-xl font-bold mb-8 italic text-slate-400 uppercase tracking-widest">D ìŠ¤í† ì–´ CLOUD</h2>
                <div class="space-y-4">
                    <input type="text" id="login-id" placeholder="ì•„ì´ë””" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none focus:border-green-500">
                    <input type="password" id="login-pw" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none focus:border-green-500">
                    <button onclick="handleLogin()" class="w-full bg-green-500 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-green-600">ë¡œê·¸ì¸</button>
                </div>
                <button onclick="toggleAuth('signup')" class="mt-8 text-sm text-slate-400 font-bold underline">íšŒì›ê°€ì… í•˜ê¸°</button>
            </div>
            <div id="signup-form" class="hidden">
                <h2 class="text-2xl font-black mb-6">íšŒì›ê°€ì…</h2>
                <input type="text" id="signup-id" placeholder="í¬ë§ ì•„ì´ë”” (ë‹‰ë„¤ì„)" class="w-full p-4 bg-slate-50 rounded-2xl border mb-3 outline-none">
                <input type="password" id="signup-pw" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full p-4 bg-slate-50 rounded-2xl border mb-6 outline-none">
                <button onclick="handleSignup()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold">ê°€ì…í•˜ê¸°</button>
                <button onclick="toggleAuth('login')" class="mt-6 text-sm text-slate-400 block w-full text-center">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <div id="main-section" class="hidden">
        <header class="bg-white/80 backdrop-blur-md border-b sticky top-[34px] z-50">
            <div class="max-w-7xl mx-auto px-6 h-20 flex justify-between items-center">
                <div class="flex items-center gap-8">
                    <span class="text-3xl font-black text-green-500 cursor-pointer" onclick="switchView('shop')">D</span>
                    <nav class="flex gap-6 font-bold text-sm text-slate-400">
                        <button id="nav-shop" onclick="switchView('shop')" class="tab-active py-2">ìŠ¤í† ì–´</button>
                        <button id="nav-mypage" onclick="switchView('mypage')" class="py-2">ë§ˆì´í˜ì´ì§€</button>
                        <button id="nav-chat" onclick="switchView('chat')" class="py-2">ë©”ì‹œì§€</button>
                    </nav>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-3 bg-slate-100 pl-4 pr-2 py-2 rounded-2xl border border-slate-200">
                        <span id="user-info" class="text-[11px] font-bold text-slate-600"></span>
                        <div class="bg-white px-3 py-1.5 rounded-xl border border-slate-200"><span id="user-balance" class="font-black text-green-600 text-[11px]">0ì›</span></div>
                        <button onclick="openChargeModal()" class="bg-green-500 text-white text-[10px] px-3 py-1.5 rounded-lg font-bold">ì¶©ì „</button>
                    </div>
                    <button onclick="handleLogout()" class="text-xs font-bold text-slate-300 hover:text-red-500">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
        </header>

        <main id="view-shop" class="max-w-7xl mx-auto p-6 md:p-10">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-10">
                <div class="lg:col-span-3">
                    <div class="flex justify-between items-center mb-10">
                        <h2 class="text-3xl font-black text-slate-800">ì¶”ì²œ ìƒí’ˆ</h2>
                        <button id="admin-btn" onclick="toggleAdminModal()" class="hidden bg-slate-900 text-white text-[11px] px-6 py-3 rounded-2xl font-bold shadow-lg">ê´€ë¦¬ì ì„¼í„°</button>
                    </div>
                    <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-8"></div>
                </div>
                <aside>
                    <div class="bg-white p-8 rounded-[3rem] shadow-xl border border-slate-100 sticky top-32">
                        <h3 class="font-black text-xl mb-6">ì¥ë°”êµ¬ë‹ˆ <span id="cart-count" class="text-xs bg-green-50 text-green-600 px-2 py-1 rounded-lg">0</span></h3>
                        <div id="cart-items" class="space-y-4 mb-8 max-h-48 overflow-y-auto text-xs font-bold text-slate-500"></div>
                        <div class="flex justify-between text-2xl font-black mb-8 border-t pt-6"><span>í•©ê³„</span><span id="final-price" class="text-green-600">0ì›</span></div>
                        <button onclick="checkout()" class="w-full bg-slate-900 text-white py-5 rounded-[2rem] font-black shadow-lg">ê²°ì œí•˜ê¸°</button>
                    </div>
                </aside>
            </div>
        </main>
        
        <main id="view-mypage" class="max-w-3xl mx-auto p-6 md:p-10 hidden"><h2 class="text-3xl font-black mb-10">ë‚´ ì£¼ë¬¸ ë‚´ì—­</h2><div id="mypage-order-list" class="space-y-4"></div></main>
        
        <main id="view-chat" class="max-w-2xl mx-auto p-6 md:p-10 hidden">
            <h2 class="text-3xl font-black mb-10">ê´€ë¦¬ì ë¬¸ì˜</h2>
            <div class="bg-white rounded-[2.5rem] shadow-xl border overflow-hidden flex flex-col h-[500px]">
                <div id="chat-window" class="flex-1 p-6 overflow-y-auto flex flex-col gap-3 bg-slate-50"></div>
                <div class="p-4 bg-white border-t flex gap-2"><input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." class="flex-1 p-4 rounded-2xl bg-slate-100 outline-none text-sm font-bold"><button onclick="sendMessage('USER')" class="bg-green-500 text-white px-6 rounded-2xl font-bold">ì „ì†¡</button></div>
            </div>
        </main>
    </div>

    <div id="admin-modal" class="fixed inset-0 bg-black/70 backdrop-blur-md z-[100] flex items-center justify-center p-4 hidden">
        <div class="bg-white w-full max-w-6xl rounded-[3rem] p-10 shadow-2xl flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-8 border-b pb-6">
                <div class="flex items-center gap-4">
                    <h2 class="text-2xl font-black">ê´€ë¦¬ì ì„¼í„°</h2>
                    <nav class="flex bg-slate-100 p-1 rounded-2xl gap-1 ml-4 text-[11px] font-bold">
                        <button onclick="switchAdminTab('products')" id="btn-tab-products" class="px-4 py-2 rounded-xl">ìƒí’ˆ ê´€ë¦¬</button>
                        <button onclick="switchAdminTab('messages')" id="btn-tab-messages" class="px-4 py-2 rounded-xl">ë©”ì‹œì§€í•¨</button>
                    </nav>
                </div>
                <button onclick="toggleAdminModal()" class="text-3xl">&times;</button>
            </div>
            <div id="admin-tab-products" class="overflow-y-auto">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="bg-slate-50 p-6 rounded-[2rem] border h-fit">
                        <h4 class="text-xs font-black mb-4 text-slate-400 uppercase">ì‹ ê·œ ìƒí’ˆ ë“±ë¡</h4>
                        <div class="space-y-3">
                            <input type="text" id="new-p-name" placeholder="ìƒí’ˆëª…" class="w-full p-3 rounded-xl border text-xs outline-none">
                            <input type="number" id="new-p-price" placeholder="ê°€ê²©(ì›)" class="w-full p-3 rounded-xl border text-xs outline-none">
                            <input type="text" id="new-p-image" placeholder="ì´ë¯¸ì§€ URL" class="w-full p-3 rounded-xl border text-xs outline-none">
                            <button onclick="addNewProduct()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold text-xs shadow-lg">ìƒí’ˆ ì¶”ê°€</button>
                        </div>
                    </div>
                    <div class="md:col-span-2"><table class="w-full text-xs text-left"><tbody id="admin-product-list-body" class="divide-y"></tbody></table></div>
                </div>
            </div>
            <div id="admin-tab-messages" class="hidden grid grid-cols-1 md:grid-cols-3 gap-6 h-[50vh]">
                <div class="bg-slate-50 rounded-3xl p-4 overflow-y-auto border"><div id="admin-chat-user-list" class="space-y-2"></div></div>
                <div class="md:col-span-2 bg-white rounded-3xl border flex flex-col overflow-hidden">
                    <div id="admin-chat-window" class="flex-1 p-6 overflow-y-auto flex flex-col gap-2 bg-slate-50 text-xs font-bold"></div>
                    <div id="admin-chat-controls" class="p-4 bg-white border-t flex gap-2 hidden">
                        <input type="text" id="admin-chat-input" placeholder="ë‹µì¥..." class="flex-1 p-3 rounded-xl bg-slate-100 outline-none text-xs font-bold">
                        <button onclick="sendMessage('ADMIN')" class="bg-slate-900 text-white px-5 rounded-xl font-bold">ì „ì†¡</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 1. Firebase ì´ˆê¸°í™”
        const firebaseConfig = {
            apiKey: "AIzaSyDqD4T5zKE0f364i3kuV_Kkg-nFQA-oB_M",
            authDomain: "hyogi090909-aa01a.firebaseapp.com",
            projectId: "hyogi090909-aa01a",
            storageBucket: "hyogi090909-aa01a.firebasestorage.app",
            messagingSenderId: "1085220308476",
            appId: "1:1085220308476:web:b698d077349f7c1df89e79",
            measurementId: "G-YM55N961MZ"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ì „ì—­ ë³€ìˆ˜
        let currentUser = JSON.parse(localStorage.getItem('D_STORE_SESSION')) || null;
        let products = [];
        let cart = [];
        let selectedUserForChat = null;

        // --- ì¸ì¦ ---
        function toggleAuth(type) { 
            document.getElementById('login-form').classList.toggle('hidden', type === 'signup'); 
            document.getElementById('signup-form').classList.toggle('hidden', type === 'login'); 
        }

        async function handleSignup() {
            const id = document.getElementById('signup-id').value.trim();
            const pw = document.getElementById('signup-pw').value.trim();
            if(!id || !pw) return alert("í•„ìˆ˜ ì…ë ¥");
            
            const userRef = db.collection("users").doc(id);
            const doc = await userRef.get();
            if(doc.exists()) return alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””");

            await userRef.set({ id, pw, balance: 0, role: id.toLowerCase() === 'admin' ? 'ADMIN' : 'USER' });
            alert("ê°€ì… ì™„ë£Œ!"); toggleAuth('login');
        }

        async function handleLogin() {
            const id = document.getElementById('login-id').value;
            const pw = document.getElementById('login-pw').value;
            const userRef = db.collection("users").doc(id);
            const doc = await userRef.get();
            
            if(doc.exists() && doc.data().pw === pw) {
                currentUser = doc.data();
                localStorage.setItem('D_STORE_SESSION', JSON.stringify(currentUser));
                showMain();
            } else {
                alert("ì •ë³´ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }
        }

        function handleLogout() { localStorage.removeItem('D_STORE_SESSION'); location.reload(); }

        function showMain() {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('main-section').classList.remove('hidden');
            document.getElementById('user-info').innerText = currentUser.id + "ë‹˜";
            if(currentUser.role === 'ADMIN') document.getElementById('admin-btn').classList.remove('hidden');
            
            // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì‹œì‘
            startRealtimeListeners();
        }

        // --- ì‹¤ì‹œê°„ ë°ì´í„° ì—°ë™ ---
        function startRealtimeListeners() {
            // ìƒí’ˆ ì—…ë°ì´íŠ¸
            db.collection("products").orderBy("createdAt", "desc").onSnapshot(snapshot => {
                products = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                renderShop();
                renderAdminProducts();
            });

            // ë‚´ ì •ë³´(ì”ì•¡) ì—…ë°ì´íŠ¸
            db.collection("users").doc(currentUser.id).onSnapshot(doc => {
                if(doc.exists()) {
                    currentUser = doc.data();
                    document.getElementById('user-balance').innerText = currentUser.balance.toLocaleString() + 'ì›';
                }
            });

            // ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
            db.collection("messages").orderBy("createdAt", "asc").onSnapshot(snapshot => {
                const msgs = snapshot.docs.map(doc => doc.data());
                renderMessages(msgs);
            });
        }

        // --- ìƒí’ˆ ê´€ë¦¬ ---
        async function addNewProduct() {
            const name = document.getElementById('new-p-name').value;
            const price = parseInt(document.getElementById('new-p-price').value);
            const image = document.getElementById('new-p-image').value || 'https://via.placeholder.com/400';
            if(!name || !price) return;
            await db.collection("products").add({ name, price, image, createdAt: Date.now() });
            alert("ìƒí’ˆ ë“±ë¡ë¨");
        }

        async function deleteProduct(id) {
            if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) await db.collection("products").doc(id).delete();
        }

        function renderShop() {
            document.getElementById('product-list').innerHTML = products.map(p => `
                <div class="bg-white p-6 rounded-[2.5rem] border hover:shadow-lg transition">
                    <img src="${p.image}" class="w-full h-40 object-cover rounded-[2rem] mb-4 shadow-sm">
                    <h3 class="font-bold text-xs mb-1 text-slate-800">${p.name}</h3>
                    <div class="flex justify-between items-center"><span class="font-black text-sm">${p.price.toLocaleString()}ì›</span>
                    <button onclick="addToCart('${p.id}')" class="bg-green-500 text-white px-4 py-2 rounded-xl text-[10px] font-bold">ë‹´ê¸°</button></div>
                </div>`).join('');
        }

        function renderAdminProducts() {
            document.getElementById('admin-product-list-body').innerHTML = products.map(p => `
                <tr class="hover:bg-slate-50">
                    <td class="py-4 font-bold">${p.name}</td>
                    <td>${p.price.toLocaleString()}ì›</td>
                    <td class="text-right"><button onclick="deleteProduct('${p.id}')" class="text-red-500 font-bold">ì‚­ì œ</button></td>
                </tr>`).join('');
        }

        // --- ì¥ë°”êµ¬ë‹ˆ & ê²°ì œ ---
        function addToCart(id) { 
            const p = products.find(item => item.id === id);
            cart.push(p); 
            updateCartUI(); 
        }

        function updateCartUI() {
            const total = cart.reduce((s, i) => s + i.price, 0);
            document.getElementById('cart-items').innerHTML = cart.map((i, idx) => `<div class="flex justify-between items-center bg-slate-50 p-3 rounded-xl"><span>${i.name}</span><button onclick="removeFromCart(${idx})" class="text-red-400">X</button></div>`).join('');
            document.getElementById('cart-count').innerText = cart.length;
            document.getElementById('final-price').innerText = total.toLocaleString() + 'ì›';
        }

        function removeFromCart(idx) { cart.splice(idx, 1); updateCartUI(); }

        async function checkout() {
            const total = cart.reduce((s, i) => s + i.price, 0);
            if(cart.length === 0) return alert("ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤.");
            if(currentUser.balance < total) return alert("ì”ì•¡ ë¶€ì¡±");

            const newBalance = currentUser.balance - total;
            await db.collection("users").doc(currentUser.id).update({ balance: newBalance });
            await db.collection("orders").add({
                userId: currentUser.id,
                items: cart.map(i => i.name).join(','),
                total,
                createdAt: Date.now()
            });

            cart = [];
            updateCartUI();
            alert("ê²°ì œ ì™„ë£Œ!");
        }

        // --- ë©”ì‹œì§€ ê¸°ëŠ¥ ---
        async function sendMessage(role) {
            const inputId = role === 'ADMIN' ? 'admin-chat-input' : 'chat-input';
            const text = document.getElementById(inputId).value.trim();
            if(!text) return;

            await db.collection("messages").add({
                sender: currentUser.id,
                receiver: role === 'ADMIN' ? selectedUserForChat : 'admin',
                text,
                createdAt: Date.now()
            });
            document.getElementById(inputId).value = '';
        }

        function renderMessages(msgs) {
            // ìœ ì €ìš© ì±„íŒ…ì°½
            const userWin = document.getElementById('chat-window');
            userWin.innerHTML = msgs.filter(m => m.sender === currentUser.id || m.receiver === currentUser.id)
                .map(m => `<div class="${m.sender === currentUser.id ? 'chat-bubble-me' : 'chat-bubble-other'} p-3 max-w-[80%] font-bold text-xs mb-1 shadow-sm">${m.text}</div>`).join('');
            userWin.scrollTop = userWin.scrollHeight;

            // ê´€ë¦¬ììš© ë¦¬ìŠ¤íŠ¸
            if(currentUser.role === 'ADMIN') {
                const uList = [...new Set(msgs.map(m => m.sender === 'admin' ? m.receiver : m.sender))].filter(id => id !== 'admin');
                document.getElementById('admin-chat-user-list').innerHTML = uList.map(uId => `
                    <div onclick="selectChatUser('${uId}')" class="p-3 rounded-xl cursor-pointer font-bold text-xs mb-1 ${selectedUserForChat === uId ? 'bg-green-500 text-white' : 'bg-white border'}">${uId}</div>
                `).join('');
                
                if(selectedUserForChat) {
                    const adminWin = document.getElementById('admin-chat-window');
                    adminWin.innerHTML = msgs.filter(m => (m.sender === selectedUserForChat && m.receiver === 'admin') || (m.sender === 'admin' && m.receiver === selectedUserForChat))
                        .map(m => `<div class="${m.sender === 'admin' ? 'chat-bubble-me' : 'chat-bubble-other'} p-2 max-w-[90%] text-[10px] font-bold mb-1 shadow-sm">${m.text}</div>`).join('');
                    adminWin.scrollTop = adminWin.scrollHeight;
                }
            }
        }

        function selectChatUser(uId) {
            selectedUserForChat = uId;
            document.getElementById('admin-chat-controls').classList.remove('hidden');
            // ë¦¬ë Œë”ë§ ìœ ë„
            db.collection("messages").limit(1).get(); 
        }

        // --- ìœ í‹¸ ---
        function switchView(v) { 
            ['shop', 'mypage', 'chat'].forEach(view => document.getElementById('view-' + view).classList.toggle('hidden', v !== view)); 
            ['nav-shop', 'nav-mypage', 'nav-chat'].forEach(nav => document.getElementById(nav).className = nav.includes(v) ? 'tab-active py-2' : 'py-2');
        }
        function toggleAdminModal() { document.getElementById('admin-modal').classList.toggle('hidden'); }
        function switchAdminTab(t) {
            document.getElementById('admin-tab-products').classList.toggle('hidden', t !== 'products');
            document.getElementById('admin-tab-messages').classList.toggle('hidden', t !== 'messages');
        }
        
        // ì´ˆê¸° ì‹¤í–‰
        if(currentUser) showMain();
    </script>
</body>
</html>
