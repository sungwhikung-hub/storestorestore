<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D 스토어 - 클라우드 통합본</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; }
        .hidden { display: none !important; }
        .tab-active { color: #22c55e; border-bottom: 3px solid #22c55e; }
    </style>
</head>
<body>

    <div id="auth-section" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md p-10 rounded-[3rem] shadow-2xl border text-center">
            <div id="login-form">
                <div class="text-6xl font-black text-green-500 mb-2">D</div>
                <h2 class="text-xl font-bold mb-8 italic text-slate-400 uppercase tracking-widest">D STORE CLOUD</h2>
                <div class="space-y-4">
                    <input type="text" id="login-id" placeholder="아이디" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none focus:border-green-500">
                    <input type="password" id="login-pw" placeholder="비밀번호" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none focus:border-green-500">
                    <button onclick="handleLogin()" class="w-full bg-green-500 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-green-600">로그인</button>
                </div>
                <button onclick="toggleAuth('signup')" class="mt-8 text-sm text-slate-400 font-bold underline">회원가입 하기</button>
            </div>
            
            <div id="signup-form" class="hidden">
                <h2 class="text-2xl font-black mb-6">회원가입</h2>
                <div class="space-y-4 text-left">
                    <input type="text" id="signup-id" placeholder="희망 아이디" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none">
                    <input type="password" id="signup-pw" placeholder="비밀번호" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none">
                    <button onclick="handleSignup()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold">가입하기</button>
                    <button onclick="toggleAuth('login')" class="mt-4 text-sm text-slate-400 block w-full text-center">취소</button>
                </div>
            </div>
        </div>
    </div>

    <div id="main-section" class="hidden">
        <header class="bg-white border-b sticky top-0 z-50 px-6 h-20 flex justify-between items-center shadow-sm">
            <div class="flex items-center gap-8">
                <span class="text-3xl font-black text-green-500 cursor-pointer" onclick="location.reload()">D</span>
                <nav class="flex gap-6 font-bold text-sm text-slate-400">
                    <button id="nav-shop" onclick="switchView('shop')" class="tab-active py-2">스토어</button>
                    <button id="nav-chat" onclick="switchView('chat')" class="py-2">메시지</button>
                </nav>
            </div>
            <div class="flex items-center gap-4">
                <div class="bg-slate-100 px-4 py-2 rounded-xl text-xs font-bold">
                    <span id="display-id"></span> | <span id="display-balance" class="text-green-600">0원</span>
                </div>
                <button id="admin-btn" onclick="toggleAdminModal()" class="hidden bg-slate-900 text-white text-[10px] px-3 py-2 rounded-lg font-bold">관리자</button>
                <button onclick="handleLogout()" class="text-xs text-slate-400 font-bold hover:text-red-500 transition">로그아웃</button>
            </div>
        </header>

        <main id="view-shop" class="max-w-7xl mx-auto p-10">
            <h2 class="text-3xl font-black mb-10 text-slate-800">전체 상품</h2>
            <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8"></div>
        </main>

        <main id="view-chat" class="max-w-2xl mx-auto p-10 hidden">
            <div class="bg-white rounded-[2rem] shadow-xl border h-[500px] flex flex-col overflow-hidden">
                <div id="chat-window" class="flex-1 p-6 overflow-y-auto flex flex-col gap-2 bg-slate-50"></div>
                <div class="p-4 flex gap-2 border-t bg-white">
                    <input type="text" id="chat-input" class="flex-1 p-3 bg-slate-100 rounded-xl outline-none" placeholder="문의사항 입력...">
                    <button onclick="sendChatMessage()" class="bg-green-500 text-white px-6 rounded-xl font-bold">전송</button>
                </div>
            </div>
        </main>
    </div>

    <div id="admin-modal" class="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-6 hidden">
        <div class="bg-white w-full max-w-2xl rounded-[2rem] p-10 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black">상품 등록 (관리자)</h2>
                <button onclick="toggleAdminModal()" class="text-2xl">&times;</button>
            </div>
            <div class="space-y-4">
                <input type="text" id="new-p-name" placeholder="상품명" class="w-full p-4 border rounded-2xl outline-none">
                <input type="number" id="new-p-price" placeholder="가격(원)" class="w-full p-4 border rounded-2xl outline-none">
                <input type="text" id="new-p-img" placeholder="이미지 URL" class="w-full p-4 border rounded-2xl outline-none">
                <button onclick="addNewProduct()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold">상품 등록하기</button>
            </div>
        </div>
    </div>

    <script>
        // 1. Firebase 설정 (사용자님 정보)
        const firebaseConfig = {
            apiKey: "AIzaSyDqD4T5zKE0f364i3kuV_Kkg-nFQA-oB_M",
            authDomain: "hyogi090909-aa01a.firebaseapp.com",
            projectId: "hyogi090909-aa01a",
            storageBucket: "hyogi090909-aa01a.firebasestorage.app",
            messagingSenderId: "1085220308476",
            appId: "1:1085220308476:web:b698d077349f7c1df89e79",
            measurementId: "G-YM55N961MZ"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentUser = null;

        // 2. 인증 함수 (doc.exists() -> doc.exists로 수정)
        function toggleAuth(type) {
            document.getElementById('login-form').classList.toggle('hidden', type === 'signup');
            document.getElementById('signup-form').classList.toggle('hidden', type === 'login');
        }

        async function handleSignup() {
            const id = document.getElementById('signup-id').value.trim();
            const pw = document.getElementById('signup-pw').value.trim();
            if(!id || !pw) return alert("아이디와 비밀번호를 입력해주세요.");
            
            try {
                const userRef = db.collection("users").doc(id);
                const doc = await userRef.get();
                
                if(doc.exists) { // 괄호 제거됨
                    alert("이미 존재하는 아이디입니다.");
                    return;
                }

                await userRef.set({
                    id, pw, balance: 100000, 
                    role: id.toLowerCase() === 'admin' ? 'ADMIN' : 'USER' 
                });
                alert("회원가입 성공!");
                toggleAuth('login');
            } catch(e) { alert("가입 실패: " + e.message); }
        }

        async function handleLogin() {
            const id = document.getElementById('login-id').value.trim();
            const pw = document.getElementById('login-pw').value.trim();
            
            try {
                const doc = await db.collection("users").doc(id).get();
                if(doc.exists && doc.data().pw === pw) {
                    currentUser = doc.data();
                    localStorage.setItem('D_SESSION', JSON.stringify(currentUser));
                    showMainStore();
                } else {
                    alert("아이디 또는 비밀번호가 틀립니다.");
                }
            } catch(e) { alert("로그인 오류: " + e.message); }
        }

        function handleLogout() { localStorage.removeItem('D_SESSION'); location.reload(); }

        // 3. 메인 기능
        function showMainStore() {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('main-section').classList.remove('hidden');
            document.getElementById('display-id').innerText = currentUser.id;
            
            if(currentUser.role === 'ADMIN') document.getElementById('admin-btn').classList.remove('hidden');
            
            loadData();
        }

        function loadData() {
            // 상품 목록 실시간 감시
            db.collection("products").orderBy("createdAt", "desc").onSnapshot(snapshot => {
                const products = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                document.getElementById('product-list').innerHTML = products.map(p => `
                    <div class="bg-white p-6 rounded-[2.5rem] border hover:shadow-lg transition">
                        <img src="${p.img || 'https://via.placeholder.com/150'}" class="w-full h-48 object-cover rounded-2xl mb-4 shadow-sm">
                        <h4 class="font-bold text-lg mb-1">${p.name}</h4>
                        <p class="text-green-600 font-black">${Number(p.price).toLocaleString()}원</p>
                    </div>
                `).join('');
            });
        }

        async function addNewProduct() {
            const name = document.getElementById('new-p-name').value;
            const price = document.getElementById('new-p-price').value;
            const img = document.getElementById('new-p-img').value;
            if(!name || !price) return alert("정보를 입력하세요.");
            
            await db.collection("products").add({ name, price, img, createdAt: Date.now() });
            alert("상품 등록 완료!");
            toggleAdminModal();
        }

        function switchView(v) {
            document.getElementById('view-shop').classList.toggle('hidden', v !== 'shop');
            document.getElementById('view-chat').classList.toggle('hidden', v !== 'chat');
            document.getElementById('nav-shop').classList.toggle('tab-active', v === 'shop');
            document.getElementById('nav-chat').classList.toggle('tab-active', v === 'chat');
        }

        function toggleAdminModal() { document.getElementById('admin-modal').classList.toggle('hidden'); }

        window.onload = () => {
            const saved = localStorage.getItem('D_SESSION');
            if(saved) {
                currentUser = JSON.parse(saved);
                showMainStore();
            }
        };
    </script>
</body>
</html>
